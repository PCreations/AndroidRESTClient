package com.pcreations.restclient;

import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.net.URI;
import java.net.URISyntaxException;

import org.apache.http.HttpEntity;
import org.apache.http.HttpResponse;
import org.apache.http.StatusLine;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.HttpClient;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.client.methods.HttpDelete;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.client.methods.HttpRequestBase;
import org.apache.http.impl.client.DefaultHttpClient;
import org.apache.http.util.EntityUtils;

import android.app.IntentService;
import android.content.Intent;
import android.net.Uri;
import android.os.Bundle;
import android.os.ResultReceiver;
import android.util.Log;

public class RestService extends IntentService{
	
	private final static String TAG = "rest";
	
	public RestService() {
		super("RestService");
		// TODO Auto-generated constructor stub
	}

	@Override
	protected void onHandleIntent(Intent intent) {
		Uri uri = intent.getData();
		Bundle bundle = intent.getExtras();
		int method = bundle.getInt(WebService.METHOD_KEY);
		//Bundle params = bundle.getParcelable(WebService.PARAMS_KEY);
		ResultReceiver receiver = bundle.getParcelable(WebService.RECEIVER_KEY);
		
		try {            
	        HttpRequestBase request = null;
	        request.setURI(new URI(uri.toString()));
	        switch (method) {
	            case WebService.GET:
	                request = new HttpGet();
	            break;
	            
	            case WebService.DELETE:
	                request = new HttpDelete();
	            break;
	     
	            case WebService.POST:
	                /*HttpPost postRequest = (HttpPost) request;
	                postRequest.setHeader('Content-Type', 'application/json')
	                if (params != null) {
	                    UrlEncodedFormEntity formEntity = new UrlEncodedFormEntity(paramsToList(params));
	                    postRequest.setEntity(formEntity);
	                }*/
	            break;
	            
	            case WebService.PUT:
	                //TODO
	            break;
	        }
	        
	        if (request != null) {
	            HttpClient client = new DefaultHttpClient();
<<<<<<< post
	            
=======

>>>>>>> local
	            Log.d(TAG, "Executing request: "+ Integer.valueOf(method) +": "+ uri.toString());
	            
	            HttpResponse response = client.execute(request);
	            
	            HttpEntity responseEntity = response.getEntity();
	            StatusLine responseStatus = response.getStatusLine();
<<<<<<< post
	            int statusCode = responseStatus != null ? responseStatus.getStatusCode() : 0;
=======
	            int        statusCode     = responseStatus != null ? responseStatus.getStatusCode() : 0;
	            
>>>>>>> local
	            if (responseEntity != null) {
	                Bundle resultData = new Bundle();
	                resultData.putString(WebService.RESULT_KEY, EntityUtils.toString(responseEntity));
	                receiver.send(statusCode, resultData);
	            }
	            else {
	                receiver.send(statusCode, null);
	            }
	        }
	    }
	    catch (URISyntaxException e) {
	        Log.e(TAG, "URI syntax was incorrect. "+ Integer.valueOf(method) +": "+ uri.toString(), e);
	        receiver.send(0, null);
	    }
	    catch (UnsupportedEncodingException e) {
	        Log.e(TAG, "A UrlEncodedFormEntity was created with an unsupported encoding.", e);
	        receiver.send(0, null);
	    }
	    catch (ClientProtocolException e) {
	        Log.e(TAG, "There was a problem when sending the request.", e);
	        receiver.send(0, null);
	    }
	    catch (IOException e) {
	        Log.e(TAG, "There was a problem when sending the request.", e);
	        receiver.send(0, null);
	    }
	}

}
